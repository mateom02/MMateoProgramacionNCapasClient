<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
       layout:decorate="~{Layout}">
    <head>
        <style>
            h2, h4{
                color: var(--text-main);
            }

            .btn-link {
                display: inline-block;
                background-color: var(--text-secondary, 1);
                color: #121317;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                text-decoration: none;
                font-weight: 500;
                font-size: 0.875rem;
            }

            .btn-link:hover {
                background-color: var(--accent-secondary);
                color: #fff;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }

            .contenedor-buscar {
                background-color: var(--bg-componente);
                border: 1px solid #2a2c30;
                border-radius: 12px;
                padding: 0.4rem 0.75rem;
                color: var(--text-main);
                font-family: 'Inter', sans-serif;
            }

            .contenedor-buscar input {
                background: transparent;
                border: none;
                outline: none;
                color: var(--text-main);
                font-size: 0.875rem;
            }

            .contenedor-buscar select{
                background: transparent;
                border: none;
                outline: none;
                color: var(--text-main);
                font-size: 0.875rem;
            }

        </style>

    </head>
    <body layout:fragment='body'  class="container">
        <!-- -->
        <div class="container-fluid" >
            <!--Header-->
            <div class="row align-items-center border-bottom border border-dark"  style="--bs-border-opacity: .5;">
                <div class="col-2 text-center">
                    <i class="bi bi-emoji-smile-fill" style="font-size: 48px; color: var(--text-main)"></i>
                </div>
                <div class="col-6 text-center">
                    <h2>Lista de usuarios</h2>
                </div> 
                <div class="col-2 ">
                    <a class='btn-link'
                       th:href="@{UsuarioIndex/add}">Agregar Usuario 
                        <i class="bi bi-plus-circle"></i></a>
                </div>
                <div class="col-2 ">
                    <a class='btn-link' 
                       th:href="@{UsuarioIndex/CargaMasiva}">Carga Masiva
                        <i class="bi bi-plus-circle"></i></a>

                </div>
            </div>

            <!-- Buscar -->
            <div class="container mt-2">
                <form th:action="@{/UsuarioIndex}" method="POST" th:object="${usuario}">
                    <div class="row">
                        <div class="col-2">
                            <h4>Buscar</h4>
                        </div>
                        <div class="col-2">
                            <div class="contenedor-buscar">
                                <input type="text" placeholder="Nombre" th:field="*{Nombre}" />
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="contenedor-buscar">
                                <input type="text" placeholder="Apellido Paterno" th:field="*{ApellidoPaterno}" />
                            </div>
                        </div>
                        <div class="col-2">             
                            <div class="contenedor-buscar">
                                <input type="text" placeholder="Apellido Paterno" th:field="*{ApellidoMaterno}" />
                            </div>
                        </div>
                        <div class="col-2">  
                            <div class="contenedor-buscar">
                                <select th:field="*{Rol.IdRol}">
                                    <option value="0" selected >Seleccione un rol</option>
                                    <option th:each="rol : ${roles}"
                                            th:value="${rol.IdRol}"
                                            th:text="${rol.Nombre}">
                                    </option>
                                </select>
                            </div>

                        </div>
                        <div class="col-2"  >
                            <input class="btn-link" type="submit">
                        </div>
                    </div>
                </form>
            </div>


            <main class="mt-3">
                <div class="table-responsive">
                    <table class="table align-middle table-dark">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Datos de contacto</th>
                                <th>Direcciones</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody> 
                            <tr th:each="usuario: ${usuarios}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i  th:style=" ${usuario.Sexo == 'F '} ? 'color: purple;' : 'color: green;'"
                                            class="bi bi-person-circle"
                                            >
                                        </i>
                                        <div class="ms-3">
                                            <p class="fw-bold mb-1" th:text="|${usuario.Nombre} ${usuario.ApellidoPaterno} ${usuario.ApellidoMaterno}|"></p>
                                            <p class="text-muted mb-0" th:text="${usuario.UserName}"></p>
                                        </div>
                                    </div>

                                </td>
                                <td>                                
                                    <div class="d-flex">
                                        <i class="bi bi-envelope-at mb-0"></i>
                                        <p class="fw-normal mb-1 ms-1" th:text="${usuario.Email}"></p>
                                    </div>
                                    <div class="d-flex">
                                        <i class="bi bi-telephone-fill mb-0 "></i>
                                        <p class="fw-normal mb-1 ms-1" th:text="${usuario.Telefono}"></p>
                                    </div>
                                    <div class="d-flex">
                                        <i class="bi bi-phone mb-0"></i>
                                        <p class="fw-normal mb-1 ms-1" th:text="${usuario.Celular}"></p>
                                    </div>
                                </td>
                                <td>
                                    <ul class="d-flex" th:each="direccion: ${usuario.Direcciones}" >
                                        <i class="bi bi-geo"></i>
                                        <li class="fw-normal mb-1 ms-1" style="list-style-type: none;" 
                                            th:text="${direccion.Calle != null} ? |${direccion.Calle}  ${direccion.NumeroExterior}| : 'No hay direcciones asignadas'"></li>

                                    </ul>
                                    <span th:if="${#lists.isEmpty(usuario.Direcciones)}">No hay direcciones asignadas</span>
                                </td>
                                <td>
                                    <span th:text="${usuario?.Rol?.Nombre}"></span>
                                </td>
                                <td>
                                    <a class='btn btn-info' th:href="@{/UsuarioIndex/usuario-detalles/{IdUsuario}(IdUsuario=${usuario.IdUsuario})}">Ver</a>
                                    <a class='btn btn-danger' th:onclick="|confimarEliminarUsuario(${usuario.IdUsuario})|" >Eliminar</a>
                                    <div class="form-check form-switch" >
                                        <input class="form-check-input"th:onclick="|cambiarStatus(${usuario.IdUsuario}, ${usuario.status})|"  type="checkbox"  th:checked="${usuario.status}">
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div> 
            </main>
        </div>
        <script th:if="${successMessage}" th:inline="javascript">
            Swal.fire({
                title: [[${successMessage}]],
                icon: "success",
                draggable: true
            });
        </script>

        <script >
            const urlBase = "http://localhost:8080/";
            function confimarEliminarUsuario(idUsuario) {
                console.log("Eliminando...");
                Swal.fire({
                    text: "¿Seguro que quieres eliminar el usuario?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, borrar!"
                }).then((result) => {

                    if (result.isConfirmed) {
                        console.log("Si");
                        $.ajax({
                            url: urlBase + "api/usuario/" + idUsuario,
                            type: "DELETE",
                            datatype: "json",
                            success: function (data, textStatus, jqXHR) {
                                if (data.correct) {
                                    Swal.fire({
                                        title: "Eliminado!",
                                        text: "El usuario se ha eliminado correctamente",
                                        icon: "success"
                                    });
                                    setTimeout(() => {
                                        location.reload();
                                    }, 1000);
                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert("algo salio mal");
                            }
                        });
                    }

                });
            }

            function  cambiarStatus(idUsuario, estatus) {

                $.ajax({
                    url: urlBase + "api/usuario/" + idUsuario + "/bajalogica",
                    type: "PATCH",
                    contentType: 'application/json',
                    data: JSON.stringify(estatus),
                    success: function (data, textStatus, jqXHR) {
                        if (data.correct) {
                            Swal.fire({
                                title: "!Estatus actualizado!",
                                text: "El estatus del usuario se ha actualizado correctamente",
                                icon: "success"
                            });
                        }
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }, error: function (jqXHR, textStatus, errorThrown) {
                        console.log(jqXHR);
                    }
                });
            }

        </script>



    </body>
</html>
